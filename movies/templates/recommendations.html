{% extends 'base.html' %}
{% load static %}

{% block title %}Recommendations - MovieHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>
    .movie-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    @media (max-width: 1200px) {
        .movie-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    @media (max-width: 768px) {
        .movie-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-4">
        <h2 class="fw-bold" style="letter-spacing: 2px;">METHODS OF RECOMMENDATION</h2>
        <p class="text-muted">Some films feel like memories you never made. Letâ€™s find the next one that feels like home.</p>
    </div>

    <!-- Controls: method and genres -->
    <form method="get" class="mb-4">
        <div class="text-center">
            <div class="mb-3">
                <label for="method" class="form-label me-2">Choose method of recommendation</label>
                <select id="method" name="method" class="form-select d-inline-block" style="width: auto; min-width: 220px;">
                    <option value="personalized" {% if method == 'personalized' %}selected{% endif %}>Personalized</option>
                    <option value="genre" {% if method == 'genre' %}selected{% endif %}>Genre based</option>
                    <option value="item_based" {% if method == 'item_based' %}selected{% endif %}>Item-based Collaborative</option>
                    <option value="hybrid" {% if method == 'hybrid' %}selected{% endif %}>Hybrid (Content + Collaborative)</option>
                </select>
            </div>
            <div class="mb-3">
                <span class="form-label d-block mb-2">Choose movie genres:</span>
                <div class="d-inline-flex flex-wrap justify-content-center" style="gap: 0.75rem; max-width: 900px;">
                    {% for gid, gname in genre_map.items %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="genres" value="{{ gid }}" id="genre-{{ gid }}" {% if gid in selected_genres %}checked{% endif %}>
                        <label class="form-check-label" for="genre-{{ gid }}">{{ gname }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Generate</button>
        </div>
    </form>

    <div class="text-center mt-4">
        <h3 class="fw-semibold">Recommended movies for you</h3>
        {% if message %}
        <p class="text-muted">{{ message }}</p>
        {% endif %}
    </div>
    {% if recommendations %}
        <div class="movie-grid">
            {% for movie in recommendations %}
            <div class="movie-card">
                <a href="{% url 'movie_detail' movie.id %}">
                    {% if movie.poster_url %}
                    <div class="movie-poster">
                        <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x450.png?text={{ movie.title|urlencode|truncatechars:20 }}';">
                    </div>
                    {% else %}
                    <div class="movie-poster movie-poster-placeholder">
                        <div class="poster-placeholder-content">
                            <i class="fas fa-film fa-3x"></i>
                            <p>{{ movie.title|truncatechars:20 }}</p>
                        </div>
                    </div>
                    {% endif %}
                </a>
                <div class="movie-info">
                    <h3 class="movie-title">{{ movie.title|truncatechars:20 }}</h3>
                    <div class="movie-meta">
                        <span class="release-year">{{ movie.release_date|slice:":4"|default:"N/A" }}</span>
                        <span class="rating"><i class="fas fa-star"></i> {{ movie.vote_average|floatformat:1 }}</span>
                    </div>
                    {% if movie.similarity_score and method != 'item_based' %}
                    <div class="mt-1">
                        <small class="text-muted">Similarity: {{ movie.similarity_score }}</small>
                    </div>
                    {% endif %}
                    {% if movie.recommended_because %}
                    <div class="recommendation-reason">
                        <small class="text-muted">
                            <i class="fas fa-user"></i> {{ movie.recommended_because.actor_name }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-results text-center">
            <i class="fas fa-film fa-3x mb-3"></i>
            <h3>No recommendations available</h3>
            <p class="text-muted">Try watching some movies to get personalized recommendations!</p>
        </div>
    {% endif %}
</div>
{% endblock %}